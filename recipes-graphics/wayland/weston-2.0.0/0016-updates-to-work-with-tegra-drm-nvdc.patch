From b9190bdfd3c5d04951a22d09e8636ac608003658 Mon Sep 17 00:00:00 2001
From: Matt Madison <matt@madison.systems>
Date: Sun, 9 Sep 2018 08:30:19 -0700
Subject: [PATCH 16/16] updates to work with tegra drm-nvdc

---
 libweston/compositor-drm.c | 17 ++++++++++++-----
 shared/weston-egl-ext.h    |  4 ----
 2 files changed, 12 insertions(+), 9 deletions(-)

diff --git a/libweston/compositor-drm.c b/libweston/compositor-drm.c
index e814208e..ba3347b8 100644
--- a/libweston/compositor-drm.c
+++ b/libweston/compositor-drm.c
@@ -117,6 +117,7 @@ struct drm_backend {
 
 	int use_pixman;
 	int use_egldevice;
+	int is_nvdc;
 
 	struct udev_input input;
 
@@ -370,8 +371,8 @@ drm_fb_create_dumb(struct drm_backend *b, int width, int height,
 	if (ret)
 		goto err_add_fb;
 
-	if (!strcmp(b->drm.filename, "drm-nvdc")) {
-		fb->map = map_arg.offset;
+	if (b->is_nvdc) {
+		fb->map = (void *) map_arg.offset;
 		fb->nounmap = true;
 	} else {
 		fb->map = mmap(NULL, fb->size, PROT_WRITE,
@@ -732,8 +733,8 @@ drm_output_repaint(struct weston_output *output_base,
 		return -1;
 
 	mode = container_of(output->base.current_mode, struct drm_mode, base);
-	if (!output->current ||
-	    output->current->stride != output->next->stride) {
+	if (!backend->is_nvdc && (!output->current ||
+				  output->current->stride != output->next->stride)) {
 		ret = drmModeSetCrtc(backend->drm.fd, output->crtc_id,
 				     output->next->fb_id, 0, 0,
 				     &output->connector_id, 1,
@@ -841,6 +842,9 @@ drm_output_start_repaint_loop(struct weston_output *output_base)
 		goto finish_frame;
 	}
 
+	if (backend->is_nvdc)
+		goto finish_frame;
+
 	/* Try to get current msc and timestamp via instant query */
 	vbl.request.type |= drm_waitvblank_pipe(output);
 	ret = drmWaitVBlank(backend->drm.fd, &vbl);
@@ -1558,6 +1562,8 @@ init_kms_caps(struct drm_backend *b)
 
 	weston_log("using %s\n", b->drm.filename);
 
+	b->is_nvdc = strcmp(b->drm.filename, "drm-nvdc") == 0;
+
 	ret = drmGetCap(b->drm.fd, DRM_CAP_TIMESTAMP_MONOTONIC, &cap);
 	if (ret == 0 && cap == 1)
 		clk_id = CLOCK_MONOTONIC;
@@ -1664,7 +1670,9 @@ drm_backend_create_gl_renderer(struct drm_backend *b)
 {
 	if (b->use_egldevice) {
 		EGLint device_platform_attribs[] = {
+#ifdef EGL_DRM_MASTER_FD_EXT
 			EGL_DRM_MASTER_FD_EXT, b->drm.fd,
+#endif
 			EGL_NONE
 		};
 
@@ -1960,7 +1968,6 @@ drm_output_init_egl(struct drm_output *output, struct drm_backend *b)
 			return -1;
 		}
 		memset(output->dumb[0]->map, 0, output->dumb[0]->size);
-
 		if (gl_renderer->output_stream_create(&output->base, ~0u,
 						      output->crtc_id) < 0) {
 			weston_log("failed to create gl renderer output stream "
diff --git a/shared/weston-egl-ext.h b/shared/weston-egl-ext.h
index 778eae07..53491cf7 100644
--- a/shared/weston-egl-ext.h
+++ b/shared/weston-egl-ext.h
@@ -180,10 +180,6 @@ typedef EGLSurface (EGLAPIENTRYP PFNEGLCREATEPLATFORMPIXMAPSURFACEEXTPROC) (EGLD
 #define EGL_PLATFORM_DEVICE_EXT 0x313F
 #endif
 
-#ifndef EGL_DRM_MASTER_FD_EXT
-#define EGL_DRM_MASTER_FD_EXT 0x333C
-#endif
-
 /*
  * FIXME: Remove both EGL_EXT_stream_acquire_mode and
  *        EGL_NV_output_drm_flip_event definitions below once both extensions
-- 
2.17.1

